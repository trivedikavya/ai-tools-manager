name: Validate Data

on:
  pull_request:
    branches: [production]
    paths:
      - "links.json"
      - "contributors.json"

jobs:
  validate-data:
    runs-on: ubuntu-latest
    # Only run for the repository owner
    if: github.actor == 'ArshdeepGrover' || github.repository_owner == 'ArshdeepGrover'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Validate all data files
        run: |
          echo "üîç Running data validation..."

          # Check if links.json exists and validate
          if [ -f "links.json" ]; then
            echo "üìù Validating links.json..."
            node validate-links.js --duplicates-only
          fi

          # Check if contributors.json exists and validate  
          if [ -f "contributors.json" ]; then
            echo "üë• Validating contributors.json..."
            node validate-contributors.js --quick
          fi

          echo "‚úÖ All validations completed successfully!"

      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Data Validation Failed**
              
              The validation found issues with your changes:
              - Check for duplicate links in links.json
              - Check for invalid contributor data in contributors.json
              
              **Fix the issues and push again:**
              \`\`\`bash
              # Test locally before pushing
              node validate-links.js --duplicates-only
              node validate-contributors.js --quick
              \`\`\`
              
              Check the [workflow logs](${context.payload.pull_request.html_url}/checks) for detailed error messages.`
            })

      - name: Comment on PR if validation passes
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Data Validation Passed**
              
              All data files have been validated successfully:
              - ‚úÖ No duplicate links found
              - ‚úÖ All contributor data is valid
              
              Ready for review and merge! üöÄ`
            })

      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = context.payload.pull_request.changed_files || [];
            let message = '‚ùå **Data Validation Failed**\n\n';

            if (changedFiles.includes('links.json')) {
              message += '‚Ä¢ **Links**: Duplicate titles or URLs detected\n';
            }

            if (changedFiles.includes('contributors.json')) {
              message += '‚Ä¢ **Contributors**: Invalid or missing contributor data\n';
            }

            message += '\nCheck the workflow logs for detailed error messages.\n';
            message += 'Please fix these issues and push your changes again.\n\n';
            message += '**Local Testing:**\n';
            message += '‚Ä¢ Links: `node validate-links.js --duplicates-only`\n';
            message += '‚Ä¢ Contributors: `node validate-contributors.js --quick`';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Comment on PR if validation passes
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = context.payload.pull_request.changed_files || [];
            let message = '‚úÖ **Data Validation Passed**\n\n';

            if (changedFiles.includes('links.json')) {
              message += '‚Ä¢ **Links**: No duplicate titles or URLs found\n';
            }

            if (changedFiles.includes('contributors.json')) {
              message += '‚Ä¢ **Contributors**: All contributor data is valid\n';
            }

            message += '\nReady for review and merge! üöÄ';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
