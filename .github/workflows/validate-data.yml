name: Validate Data

on:
  pull_request:
    paths:
      - "data/links.json"
      - "data/contributors.json"

jobs:
  validate-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Validate all data files
        run: |
          echo "üîç Running data validation..."

          # Check if links.json exists and validate
          if [ -f "data/links.json" ]; then
            echo "üìù Validating links.json..."
            node scripts/validate-links.js --duplicates-only
          fi

          # Check if contributors.json exists and validate  
          if [ -f "data/contributors.json" ]; then
            echo "üë• Validating contributors.json..."
            node scripts/validate-contributors.js --quick
          fi

          echo "‚úÖ All validations completed successfully!"



      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = context.payload.pull_request.changed_files || [];
            let message = '‚ùå **Data Validation Failed**\n\n';

            if (changedFiles.includes('data/links.json')) {
              message += '‚Ä¢ **Links**: Duplicate titles or URLs detected\n';
            }

            if (changedFiles.includes('data/contributors.json')) {
              message += '‚Ä¢ **Contributors**: Invalid or missing contributor data\n';
            }

            message += '\nCheck the workflow logs for detailed error messages.\n';
            message += 'Please fix these issues and push your changes again.\n\n';
            message += '**Local Testing:**\n';
            message += '‚Ä¢ Links: `node scripts/validate-links.js --duplicates-only`\n';
            message += '‚Ä¢ Contributors: `node scripts/validate-contributors.js --quick`';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Comment on PR if validation passes
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = context.payload.pull_request.changed_files || [];
            let message = '‚úÖ **Data Validation Passed**\n\n';

            if (changedFiles.includes('data/links.json')) {
              message += '‚Ä¢ **Links**: No duplicate titles or URLs found\n';
            }

            if (changedFiles.includes('data/contributors.json')) {
              message += '‚Ä¢ **Contributors**: All contributor data is valid\n';
            }

            message += '\nReady for review and merge! üöÄ';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
